# ğŸ“˜ **README â€” GWAS QC + GCTA MLM Pipeline**
### *Complete End-to-End Workflow for GWAS Quality Control and Mixed-Model Association (GCTA-MLMA)*
**Author:** Etienne Ntumba Kabongo  
**Contact:** etienne.kabongo@mcgill.ca  
**Last update:** December 2025

---

# ğŸ”· **Overview**

This repository provides a fully automated pipeline to perform:

1. **Comprehensive GWAS Quality Control (QC)** using PLINK  
2. **LD pruning, kinship matrix (GRM) computation**, and  
3. **Mixed-Model Genome-Wide Association Analysis (MLMA)** using **GCTA**  
4. **Post-GWAS visualization**, including  
   - Manhattan plot  
   - QQ plot  
   - Genomic inflation factor Î»GC  

The workflow is designed for **HPC environments** using **PBS job scheduling** (CHPC, SLURM equivalent setups, etc.).  
All steps are optimized for **large imputed genotype datasets**.

---

# ğŸ“ **Project Structure**

```
project/
â”‚
â”œâ”€â”€ gwas_qc_pipeline_improve.sh       # Full QC workflow (PLINK)
â”œâ”€â”€ gwas_qc_gcta.pbs                  # PBS script (QC â†’ GCTA â†’ plots)
â”œâ”€â”€ gwas_gcta_plots.R                 # Manhattan/QQ/Î»GC generator
â”‚
â”œâ”€â”€ qc_results/
â”‚   â”œâ”€â”€ step1_initial/
â”‚   â”œâ”€â”€ step2_snp_qc/
â”‚   â”œâ”€â”€ step3_sample_qc/
â”‚   â”œâ”€â”€ step4_relatedness/
â”‚   â”œâ”€â”€ step5_final/                 # QC final PLINK files
â”‚   â”œâ”€â”€ gcta/                        # GCTA results (GRM + MLMA)
â”‚   â””â”€â”€ plots/                       # Figures (PCA, QQ, Manhattan)
â”‚
â””â”€â”€ logs/                            # HPC job logs
```

---

# ğŸ§¬ **1. Requirements**

### **Software**
| Tool | Version | Purpose |
|------|---------|---------|
| PLINK | 1.9 | QC, LD pruning, file conversions |
| GCTA | â‰¥1.94 | Kinship matrix + Mixed-model association |
| R | â‰¥4.0 | Manhattan/QQ plots |
| PBS / SLURM | â€” | Job scheduling on HPC |

---

# ğŸš€ **2. Launch the Full Pipeline (QC â†’ GCTA â†’ Plots)**

Submit the PBS job:

```bash
qsub gwas_qc_gcta.pbs
```

This script performs:

- QC on raw PLINK files  
- Kinship matrix (GRM) generation  
- MLMA GWAS using GCTA  
- Manhattan, QQ, and Î»GC plots  

Outputs are stored in:

```
qc_results/
   step5_final/       # QC-cleaned data
   gcta/              # GCTA MLMA results
   plots/             # PCA plots
```

---

# ğŸ” **3. GWAS QC (gwas_qc_pipeline_improve.sh)**

QC steps include:

### **3.1 SNP-Level Filters**
- Call rate (`--geno 0.02`)
- Minor Allele Frequency (`--maf 0.01`)
- Hardy-Weinberg equilibrium (`--hwe 1e-6`)

### **3.2 Sample-Level Filters**
- Individual missingness (`--mind 0.02`)
- Sex-check (if chrX present)
- Heterozygosity outliers (Â±3 SD)
- Relatedness (PI_HAT > 0.1875)
- PCA outliers (Â±6 SD on PC1/PC2)

### **3.3 Final Outputs**
```
qc_results/step5_final/qc_final.bed
qc_results/step5_final/qc_final.bim
qc_results/step5_final/qc_final.fam
qc_results/step5_final/covariates.txt
qc_results/QC_REPORT.txt
```

---

# ğŸ§© **4. Kinship Matrix (GRM) with GCTA**

The GRM is built after LD pruning:

```bash
plink --bfile qc_final       --indep-pairwise 50 5 0.2       --maf 0.05       --out gcta_ld_pruned

plink --bfile qc_final       --extract gcta_ld_pruned.prune.in       --make-grm       --out gcta_grm
```

Outputs:

```
gcta_grm.grm.bin
gcta_grm.grm.id
gcta_grm.grm.N.bin
```

---

# ğŸ§ª **5. Mixed-Model GWAS (GCTA MLMA)**

### **Phenotype file**

```
FID IID PHENO
```

Created by:

```bash
awk '{print $1, $2, $6}' qc_final.fam > gcta_pheno.txt
```

### **Covariate file**

Includes:

- Sex
- PCs 1â€“10

Created automatically by QC pipeline.

### **Run GCTA MLM**

```bash
gcta64 --mlma        --bfile qc_final        --grm gcta_grm        --pheno gcta_pheno.txt        --covar gcta_covars.txt        --out gcta_mlma_results
```

Output:

```
gcta_mlma_results.mlma
```

Columns include:

- CHR  
- SNP  
- BP  
- A1/A2  
- BETA / SE  
- P (association p-value)

---

# ğŸ“Š **6. Manhattan, QQ Plot, and Î»GC**

Generated by **gwas_gcta_plots.R**:

```bash
Rscript gwas_gcta_plots.R qc_results/gcta/gcta_mlma_results.mlma
```

Outputs:

```
gcta_manhattan.png
gcta_qqplot.png
gcta_lambda_gc.txt
```

### **Genomic inflation factor**
```
lambda_gc = median(Ï‡Â²_observed) / median(Ï‡Â²_expected)
```

---

# ğŸ“ˆ **7. Interpretation Guidelines**

### **QQ Plot**
- Points close to diagonal â†’ well-calibrated model  
- Early upward deviation â†’ polygenicity  
- Extreme inflation â†’ population structure not fully corrected  

### **Manhattan Plot**
- Red dashed line = genome-wide significance (5e-8)
- Peaks above threshold â†’ candidate loci  

### **Î»GC Interpretation**
| Î»GC | Interpretation |
|------|----------------|
| 1.00â€“1.05 | Excellent, no inflation |
| 1.10â€“1.20 | Acceptable for polygenic traits |
| >1.30 | Possible stratification or QC issues |

---

# ğŸ§° **8. HPC Notes (PBS)**

### Submit:

```bash
qsub gwas_qc_gcta.pbs
```

### Adjust resources:

Edit inside the PBS script:

```
#PBS -l select=1:ncpus=8:mem=64GB
#PBS -l walltime=06:00:00
```

---

# ğŸ **9. Final Output Summary**

After full execution, you will obtain:

```
qc_results/
â”‚
â”œâ”€â”€ step5_final/
â”‚   â”œâ”€â”€ qc_final.bed/.bim/.fam
â”‚   â”œâ”€â”€ covariates.txt
â”‚
â”œâ”€â”€ gcta/
â”‚   â”œâ”€â”€ gcta_grm.*
â”‚   â”œâ”€â”€ gcta_mlma_results.mlma
â”‚   â”œâ”€â”€ gcta_manhattan.png
â”‚   â”œâ”€â”€ gcta_qqplot.png
â”‚   â”œâ”€â”€ gcta_lambda_gc.txt
â”‚
â””â”€â”€ QC_REPORT.txt
```

---

# ğŸ™Œ **10. Citation**

If you use this pipeline, please cite:

- **PLINK:** Purcell et al., 2007; Chang et al., 2015  
- **GCTA:** Yang et al., 2011  
- **R:** R Core Team  

---

# ğŸ“ **11. Contact**

For questions or collaboration:

**Etienne Ntumba Kabongo**  
Email: *etienne.kabongo@mcgill.ca*  
Affiliation: Mcgill's University / Audrey Grant Lab  
# gwas-gcta-pipeline
